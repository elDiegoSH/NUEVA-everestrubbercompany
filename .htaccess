# ============================================
# EVEREST RUBBER COMPANY - .HTACCESS OPTIMIZADO
# Optimizado para SEO, velocidad y seguridad
# ============================================

# Activar motor de reescritura
RewriteEngine On
Options +FollowSymLinks -Indexes

# ============================================
# 1. REDIRECCIONES Y HTTPS
# ============================================

# Redirigir HTTP a HTTPS
RewriteCond %{HTTPS} !=on
RewriteRule ^(.*)$ https://%{HTTP_HOST}/$1 [R=301,L,NE]

# Redirigir dominio antiguo al nuevo
RewriteCond %{HTTP_HOST} ^grupoeverest\.com\.mx$ [NC]
RewriteRule ^(.*)$ https://everestrubbercompany.com/$1 [R=301,L]

# Redirigir www a non-www (si es necesario)
# RewriteCond %{HTTP_HOST} ^www\.everestrubbercompany\.com$ [NC]
# RewriteRule ^(.*)$ https://everestrubbercompany.com/$1 [R=301,L]

# ============================================
# 2. COMPRESIÓN (GZIP/BROTLI)
# ============================================

<IfModule mod_deflate.c>
    # Habilitar compresión
    AddOutputFilterByType DEFLATE text/plain
    AddOutputFilterByType DEFLATE text/html
    AddOutputFilterByType DEFLATE text/xml
    AddOutputFilterByType DEFLATE text/css
    AddOutputFilterByType DEFLATE text/javascript
    AddOutputFilterByType DEFLATE application/xml
    AddOutputFilterByType DEFLATE application/xhtml+xml
    AddOutputFilterByType DEFLATE application/rss+xml
    AddOutputFilterByType DEFLATE application/javascript
    AddOutputFilterByType DEFLATE application/x-javascript
    AddOutputFilterByType DEFLATE application/json
    AddOutputFilterByType DEFLATE application/vnd.ms-fontobject
    AddOutputFilterByType DEFLATE application/x-font-ttf
    AddOutputFilterByType DEFLATE image/svg+xml
    
    # Excluir navegadores antiguos
    BrowserMatch ^Mozilla/4 gzip-only-text/html
    BrowserMatch ^Mozilla/4\.0[678] no-gzip
    BrowserMatch \bMSIE !no-gzip !gzip-only-text/html
</IfModule>

# ============================================
# 3. CABECERAS DE SEGURIDAD (CRÍTICO)
# ============================================

<IfModule mod_headers.c>
    # HSTS (HTTP Strict Transport Security) - 1 año
    Header always set Strict-Transport-Security "max-age=31536000; includeSubDomains; preload"
    
    # Protección XSS
    Header always set X-XSS-Protection "1; mode=block"
    
    # Prevenir MIME sniffing
    Header always set X-Content-Type-Options "nosniff"
    
    # Prevenir clickjacking
    Header always set X-Frame-Options "SAMEORIGIN"
    
    # Política de referencias
    Header always set Referrer-Policy "strict-origin-when-cross-origin"
    
    # Permisos de características
    Header always set Permissions-Policy "geolocation=(), microphone=(), camera=()"
    
    # CSP (Content Security Policy) - BÁSICO - AJUSTAR SEGÚN TUS NECESIDADES
    # Header always set Content-Security-Policy "default-src 'self' https: data: 'unsafe-inline' 'unsafe-eval';"
    
    # Upgrade insecure requests (redirigir HTTP a HTTPS)
    Header always set Content-Security-Policy "upgrade-insecure-requests"
    
    # Headers de caché específicos
    <FilesMatch "\.(webp|jpg|jpeg|png|gif|ico|svg|woff2|woff|ttf|otf|eot)$">
        Header set Cache-Control "public, immutable, max-age=31536000"
        Header unset Last-Modified
    </FilesMatch>
    
    <FilesMatch "\.(css|js)$">
        Header set Cache-Control "public, max-age=2592000"
    </FilesMatch>
    
    <FilesMatch "\.(html|htm|php)$">
        Header set Cache-Control "public, max-age=3600"
    </FilesMatch>
</IfModule>

# ============================================
# 4. CACHÉ (EXPIRES HEADERS)
# ============================================

<IfModule mod_expires.c>
    ExpiresActive On
    
    # Imágenes - 1 año
    ExpiresByType image/jpeg "access plus 1 year"
    ExpiresByType image/jpg "access plus 1 year"
    ExpiresByType image/png "access plus 1 year"
    ExpiresByType image/gif "access plus 1 year"
    ExpiresByType image/webp "access plus 1 year"
    ExpiresByType image/svg+xml "access plus 1 year"
    ExpiresByType image/x-icon "access plus 1 year"
    ExpiresByType image/bmp "access plus 1 year"
    
    # Fuentes - 1 año
    ExpiresByType font/woff2 "access plus 1 year"
    ExpiresByType font/woff "access plus 1 year"
    ExpiresByType font/ttf "access plus 1 year"
    ExpiresByType font/otf "access plus 1 year"
    ExpiresByType application/vnd.ms-fontobject "access plus 1 year"
    
    # CSS y JS - 1 mes
    ExpiresByType text/css "access plus 1 month"
    ExpiresByType application/javascript "access plus 1 month"
    ExpiresByType application/x-javascript "access plus 1 month"
    
    # Archivos de medios - 1 año
    ExpiresByType video/mp4 "access plus 1 year"
    ExpiresByType video/webm "access plus 1 year"
    ExpiresByType audio/mpeg "access plus 1 year"
    ExpiresByType audio/ogg "access plus 1 year"
    
    # Documentos - 1 semana
    ExpiresByType application/pdf "access plus 1 week"
    ExpiresByType application/msword "access plus 1 week"
    
    # HTML - 1 hora (para contenido dinámico)
    ExpiresByType text/html "access plus 1 hour"
    
    # Por defecto - 1 semana
    ExpiresDefault "access plus 1 week"
</IfModule>

# ============================================
# 5. PROTECCIÓN DE ARCHIVOS SENSIBLES
# ============================================

# Bloquear acceso a archivos ocultos (comienzan con punto)
<FilesMatch "^\.">
    Order allow,deny
    Deny from all
</FilesMatch>

# Bloquear archivos sensibles
<FilesMatch "\.(env|log|ini|conf|sql|bak|tar|gz|zip)$">
    Order allow,deny
    Deny from all
</FilesMatch>

# Proteger wp-admin (si usas WordPress en algún subdirectorio)
# <IfModule mod_rewrite.c>
#     RewriteCond %{REQUEST_URI} ^.*/wp-admin/?$
#     RewriteRule ^ - [F,L]
# </IfModule>

# ============================================
# 6. ERROR PAGES PERSONALIZADAS
# ============================================

ErrorDocument 400 /errors/400.html
ErrorDocument 401 /errors/401.html
ErrorDocument 403 /errors/403.html
ErrorDocument 404 /errors/404.html
ErrorDocument 500 /errors/500.html

# Si no tienes páginas de error personalizadas, usar estas simples:
# ErrorDocument 404 "<h1>Página no encontrada</h1><p>La página que buscas no existe en Everest Rubber Company.</p>"
# ErrorDocument 500 "<h1>Error del servidor</h1><p>Disculpa las molestias. Estamos trabajando en solucionarlo.</p>"

# ============================================
# 7. SEO - URL AMIGABLES Y REDIRECCIONES
# ============================================

# Si necesitas URLs amigables (ej: de /producto.php?id=1 a /producto/1/)
# Descomenta y ajusta según tu estructura:

# RewriteCond %{REQUEST_FILENAME} !-f
# RewriteCond %{REQUEST_FILENAME} !-d
# RewriteRule ^producto/([0-9]+)/?$ producto.php?id=$1 [L,QSA]

# ============================================
# 8. OPTIMIZACIONES ADICIONALES
# ============================================

# Deshabilitar firma del servidor
ServerSignature Off

# Limitar métodos HTTP (solo GET, POST, HEAD)
# <LimitExcept GET POST HEAD>
#     Deny from all
# </LimitExcept>

# Prevenir hotlinking de imágenes (si quieres)
# RewriteCond %{HTTP_REFERER} !^$
# RewriteCond %{HTTP_REFERER} !^https?://(www\.)?everestrubbercompany\.com/.*$ [NC]
# RewriteRule \.(jpg|jpeg|png|gif|webp)$ - [F,NC]

# ============================================
# 9. CONFIGURACIÓN PHP (cPanel)
# ============================================

<IfModule mime_module>
    AddHandler application/x-httpd-ea-php74 .php .php7 .phtml
</IfModule>

# Aumentar límites PHP (si es necesario)
# php_value upload_max_filesize 64M
# php_value post_max_size 64M
# php_value max_execution_time 300
# php_value max_input_time 300

# ============================================
# 10. MIME TYPES (actualizados)
# ============================================

<IfModule mod_mime.c>
    # WebP (moderno)
    AddType image/webp .webp
    
    # Fuentes modernas
    AddType font/woff2 .woff2
    AddType font/woff .woff
    
    # SVG
    AddType image/svg+xml .svg .svgz
    
    # JSON
    AddType application/json .json
    
    # JavaScript moderno
    AddType application/javascript .js .mjs
    
    # CSS
    AddType text/css .css
    
    # HTML
    AddType text/html .html .htm
    
    # XML
    AddType text/xml .xml
    
    # Documentos
    AddType application/pdf .pdf
    AddType application/msword .doc .docx
    AddType application/vnd.ms-excel .xls .xlsx
    AddType application/vnd.ms-powerpoint .ppt .pptx
</IfModule>